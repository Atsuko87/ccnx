####
#### DebugDeltas.txt
####
#### Commands to test a "big" repo.
####
# To run this test one needs three bash shells.
# It can be useful to start them as separate tabs.
# A SyncUpdateRoot line in the logs shows where trees have been created.
# A client may need to set CCNX_HOME below to a different value (see below).
# We assume that ccndstart and ccnrm can be found on the search path.

## in shell 0: setup of default environment
# change the next line to change the value of CCNX_HOME!
cd ~/CCN/ccnx
echo "export CCNX_HOME=`pwd`" >/var/tmp/SyncSetup.txt
echo 'export CCNR_NAME=repo.$$' >>/var/tmp/SyncSetup.txt
echo 'export CCNR_DIRECTORY=$CCNX_HOME/$CCNR_NAME.dir' >>/var/tmp/SyncSetup.txt
echo 'rm -Rf $CCNR_DIRECTORY' >>/var/tmp/SyncSetup.txt
echo 'export CCNR_DEBUG=INFO' >>/var/tmp/SyncSetup.txt
echo 'export CCNS_DEBUG=FINE' >>/var/tmp/SyncSetup.txt
echo 'export CCNS_DELTAS_LIMIT=2000' >>/var/tmp/SyncSetup.txt
echo 'export CCN_LOCAL_PORT_BASE=64000' >>/var/tmp/SyncSetup.txt
echo 'export LONG_LINES=100000' >>/var/tmp/SyncSetup.txt
echo 'cd $CCNX_HOME/csrc/sync' >>/var/tmp/SyncSetup.txt
echo '. ../sync_nerf/functions' >>/var/tmp/SyncSetup.txt
source /var/tmp/SyncSetup.txt

## in shell 0: optional test data (/var/tmp/nuttin /var/tmp/2MB)

echo "Nuttin much" >/var/tmp/nuttin
mkfile 2m /var/tmp/2MB
mkdir $CCNX_HOME/csrc/sync/test

MyCCN () {
   ps auxc | grep ccn | grep $USER
}
KillMyCCN () {
   kill `ps auxc | grep ccnd | grep $USER  | awk '{print $2}' -`
}
StartCCN2 () {
    export CCN_LOCAL_PORT=$((CCN_LOCAL_PORT_BASE + 0))
    WithCCND 1 ccnd 2>test/ccnd.1.txt &
    WithCCND 2 ccnd 2>test/ccnd.2.txt &
    Linkup 1 2
}

## in shell 0: OPTIONAL cleanup of old repo runs

rm -Rf $CCNX_HOME/repo.*.dir $CCNX_HOME/ccnr.*.txt

## in shell 0: start 2 ccnd's

StartCCN2

## in shell 1, start an empty repo under gdb

. /var/tmp/SyncSetup.txt
rm -Rf $CCNR_DIRECTORY; mkdir $CCNR_DIRECTORY
WithCCND 1 gdb $CCNX_HOME/csrc/ccnr/ccnr
b SyncUtil.c:42
run

## in shell 2, start an empty repo under gdb

. /var/tmp/SyncSetup.txt
rm -Rf $CCNR_DIRECTORY; mkdir $CCNR_DIRECTORY
WithCCND 2 gdb $CCNX_HOME/csrc/ccnr/ccnr
b SyncUtil.c:42
run

## in shell 0: small tests

WithCCND 1 SyncTest -scope 1 -slice /parc/sync ccnx:/test
WithCCND 2 SyncTest -scope 1 -slice /parc/sync ccnx:/test

WithCCND 1 SyncTest -put /var/tmp/nuttin ccnx:/test/nuttinA
WithCCND 1 SyncTest -put /var/tmp/nuttin ccnx:/test/nuttinX
WithCCND 2 SyncTest -put /var/tmp/nuttin ccnx:/test/nuttinY

WithCCND 1 SyncTest -put /var/tmp/2MB ccnx:/test/2MB/A



