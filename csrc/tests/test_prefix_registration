# tests/test_prefix_registration
# 
# Part of the CCNx distribution.
#
# Copyright (C) 2009 Palo Alto Research Center, Inc.
#
# This work is free software; you can redistribute it and/or modify it under
# the terms of the GNU General Public License version 2 as published by the
# Free Software Foundation.
# This work is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.
#
AFTER : test_single_ccnd
BEFORE : test_single_ccnd_teardown

ccndsmoketest || SkipTest no ccnd

# Create the body of a simple registration request (with zero-length content)

: | ccnput -f /test/registered/prefix

# Pull it out to use in the registration request.  Base-64 encode it for the benefit of the shell.

NBLOB="`ccnget /test/registered/prefix | openssl enc -base64`"

echo NBLOB is $NBLOB >&2

# Now construct the interest.
ccn_xmltoccnb -w - <<EOF >registration-request.ccnb
<Interest>
  <Name>
    <Component ccnbencoding="text">ccnx</Component>
    <Component ccnbencoding="text">reg</Component>
    <Component ccnbencoding="text">self</Component>
    <Component ccnbencoding="base64Binary">$NBLOB</Component>
  </Name>
</Interest>
EOF

test $? -eq 0 || Fail botch constructing registration-request.ccnb

# Try out the registration request
ccndsmoketest -b send registration-request.ccnb recv > registration-response.ccnb

: | cmp -s - registration-response.ccnb && SkipTest no registration response, might be a sporadic failure

ccn_ccnbtoxml registration-response.ccnb || Fail did not get registration response

ccnbx -d registration-response.ccnb Content | ccn_ccnbtoxml -x -

# Testing for the reg request to time out would be more complicated.
rm registration-*.ccnb
